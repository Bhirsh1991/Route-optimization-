<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×××¨×’×Ÿ × ×¡×™×¢×•×ª ××•×¤×˜×™××œ×™</title>
    <link rel="icon" type="image/png" href="appLogo.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .step-card {
            border: 1px solid #e2e8f0;
        }

        .step-card[data-complete="true"] .step-indicator {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }

        .step-card[data-complete="true"] .step-title {
            color: #0f172a;
        }

        .step-card[data-active="true"] {
            box-shadow: 0 12px 30px -25px rgba(15, 23, 42, 0.4);
        }

        .chip {
            user-select: none;
        }

        .chip.dragging {
            opacity: 0.6;
        }

        .save-success {
            animation: pulse-success 1.4s ease;
        }

        @keyframes pulse-success {
            0% {
                transform: scale(0.97);
                opacity: 0.4;
            }
            40% {
                transform: scale(1.02);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .step-status {
            max-width: 180px;
            line-height: 1.4;
            text-align: right;
            white-space: normal;
        }

        @media (max-width: 640px) {
            .step-status {
                max-width: 140px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 flex items-start sm:items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-3xl">
        <div class="flex flex-col items-center mb-6 text-center">
            <img src="https://github.com/Bhirsh1991/Route-optimization-/blob/main/appLogo.png?raw=true" alt="×œ×•×’×• ×”××¤×œ×™×§×¦×™×”" class="w-16 h-16 rounded-full object-cover shadow-sm">
            <h1 class="text-2xl sm:text-3xl font-bold mt-4 text-slate-900">×××¨×’×Ÿ × ×¡×™×¢×•×ª ××•×¤×˜×™××œ×™</h1>
            <p class="text-sm text-slate-500 mt-1">×‘×•× ×™× ××¡×œ×•×œ ×—×›× ×‘×¦×¢×“×™× ×¤×©×•×˜×™×</p>
        </div>

        <div id="messageBox" class="mt-4 p-3 rounded-xl hidden" role="status"></div>

        <div class="space-y-4">
            <section class="step-card rounded-2xl bg-white" data-step="1" data-active="true" data-complete="false">
                <button type="button" class="w-full flex items-center justify-between p-4 sm:p-5" data-step-toggle>
                    <div class="flex items-center gap-3">
                        <span class="step-indicator w-9 h-9 rounded-full border border-slate-200 bg-slate-100 flex items-center justify-center text-slate-500 font-semibold">1</span>
                        <div>
                            <p class="step-title text-lg font-semibold text-slate-700">× ×§×•×“×ª ×”×ª×—×œ×”</p>
                            <p class="text-sm text-slate-400">×‘×—×¨ × ×§×•×“×ª ×™×¦×™××” ×œ××¡×œ×•×œ</p>
                        </div>
                    </div>
                    <span id="startStepStatus" class="step-status text-sm text-slate-500">â³ ×¢×“×™×™×Ÿ ×œ× × ×‘×—×¨×”</span>
                </button>
                <div class="step-body px-4 pb-5 sm:px-5">
                    <div class="bg-slate-50 rounded-xl p-4 sm:p-5">
                        <label for="startAddressInput" class="block text-sm font-medium text-slate-700 mb-3">×›×ª×•×‘×ª ×”×ª×—×œ×”</label>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="text" id="startAddressInput" list="startSuggestions" placeholder="×”×–×Ÿ ×›×ª×•×‘×ª ××• ××§×•×"
                                   class="shadow-sm border border-slate-200 rounded-xl w-full py-2.5 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                            <datalist id="startSuggestions"></datalist>
                            <button id="setStartLocationBtn"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-xl whitespace-nowrap">
                                ğŸ“ ×‘×—×¨ × ×§×•×“×ª ×”×ª×—×œ×”
                            </button>
                        </div>
                        <div id="currentStartLocation" class="mt-3 text-sm text-slate-600"></div>
                        <button id="clearStartLocationBtn" class="mt-3 text-xs text-slate-400 hover:text-slate-600 underline">× ×§×” ×‘×—×™×¨×”</button>
                    </div>
                </div>
            </section>

            <section class="step-card rounded-2xl bg-white" data-step="2" data-active="false" data-complete="false">
                <button type="button" class="w-full flex items-center justify-between p-4 sm:p-5" data-step-toggle>
                    <div class="flex items-center gap-3">
                        <span class="step-indicator w-9 h-9 rounded-full border border-slate-200 bg-slate-100 flex items-center justify-center text-slate-500 font-semibold">2</span>
                        <div>
                            <p class="step-title text-lg font-semibold text-slate-700">× ×§×•×“×ª ×¡×™×•×</p>
                            <p class="text-sm text-slate-400">×‘×—×¨ ×™×¢×“ ×œ××¡×œ×•×œ</p>
                        </div>
                    </div>
                    <span id="endStepStatus" class="step-status text-sm text-slate-500">â³ ×¢×“×™×™×Ÿ ×œ× × ×‘×—×¨×”</span>
                </button>
                <div class="step-body hidden px-4 pb-5 sm:px-5">
                    <div class="bg-slate-50 rounded-xl p-4 sm:p-5">
                        <label for="endAddressInput" class="block text-sm font-medium text-slate-700 mb-3">×›×ª×•×‘×ª ×¡×™×•×</label>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="text" id="endAddressInput" list="endSuggestions" placeholder="×”×–×Ÿ ×›×ª×•×‘×ª ××• ××§×•×"
                                   class="shadow-sm border border-slate-200 rounded-xl w-full py-2.5 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                            <datalist id="endSuggestions"></datalist>
                            <button id="setEndLocationBtn"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-xl whitespace-nowrap">
                                ğŸ“ ×‘×—×¨ × ×§×•×“×ª ×¡×™×•×
                            </button>
                        </div>
                        <div id="currentEndLocation" class="mt-3 text-sm text-slate-600"></div>
                        <button id="clearEndLocationBtn" class="mt-3 text-xs text-slate-400 hover:text-slate-600 underline">× ×§×” ×‘×—×™×¨×”</button>
                    </div>
                </div>
            </section>

            <section class="step-card rounded-2xl bg-white" data-step="3" data-active="false" data-complete="false">
                <button type="button" class="w-full flex items-center justify-between p-4 sm:p-5" data-step-toggle>
                    <div class="flex items-center gap-3">
                        <span class="step-indicator w-9 h-9 rounded-full border border-slate-200 bg-slate-100 flex items-center justify-center text-slate-500 font-semibold">3</span>
                        <div>
                            <p class="step-title text-lg font-semibold text-slate-700">×¢×¦×™×¨×•×ª ×‘×™× ×™×™×</p>
                            <p class="text-sm text-slate-400">××•×¤×¦×™×•× ×œ×™ Â· ×”×•×¡×£ × ×§×•×“×•×ª ×‘×“×¨×š</p>
                        </div>
                    </div>
                    <span id="intermediateStepStatus" class="step-status text-sm text-slate-500">â• ×”×•×¡×¤×” ×—×•×¤×©×™×ª</span>
                </button>
                <div class="step-body hidden px-4 pb-5 sm:px-5">
                    <div class="bg-slate-50 rounded-xl p-4 sm:p-5 space-y-4">
                        <div>
                            <label for="intermediateAddressInput" class="block text-sm font-medium text-slate-700 mb-3">×”×•×¡×£ ×¢×¦×™×¨×ª ×‘×™× ×™×™×</label>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <input type="text" id="intermediateAddressInput" list="intermediateSuggestions" placeholder="×œ×“×•×’××”: ×¨×—×•×‘ ×”×¨×¦×œ 1, ×ª×œ ××‘×™×‘"
                                       class="shadow-sm border border-slate-200 rounded-xl w-full py-2.5 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                                <datalist id="intermediateSuggestions"></datalist>
                                <button id="addIntermediateLocationBtn"
                                        class="bg-slate-900 hover:bg-slate-800 text-white font-semibold py-2.5 px-5 rounded-xl whitespace-nowrap">
                                    â• ×”×•×¡×£ ×¢×¦×™×¨×”
                                </button>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-semibold text-slate-700">×”×¢×¦×™×¨×•×ª ×©×œ×š</p>
                                <span class="text-xs text-slate-400">×’×¨×•×¨ ×œ×©×™× ×•×™ ×¡×“×¨</span>
                            </div>
                            <div id="intermediateLocationsList" class="mt-3 flex flex-wrap gap-2 min-h-[48px]" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="step-card rounded-2xl bg-white" data-step="4" data-active="false" data-complete="false">
                <button type="button" class="w-full flex items-center justify-between p-4 sm:p-5" data-step-toggle>
                    <div class="flex items-center gap-3">
                        <span class="step-indicator w-9 h-9 rounded-full border border-slate-200 bg-slate-100 flex items-center justify-center text-slate-500 font-semibold">4</span>
                        <div>
                            <p class="step-title text-lg font-semibold text-slate-700">×©××™×¨×ª ××¡×œ×•×œ</p>
                            <p class="text-sm text-slate-400">×©××•×¨ ×œ×©×™××•×© ×—×•×–×¨ ×‘××—×©×‘ ×”×–×”</p>
                        </div>
                    </div>
                    <span id="saveStepStatus" class="step-status text-sm text-slate-500">ğŸ’¾ ×¢×“×™×™×Ÿ ×œ× × ×©××¨</span>
                </button>
                <div class="step-body hidden px-4 pb-5 sm:px-5">
                    <div class="bg-slate-50 rounded-xl p-4 sm:p-5 space-y-4">
                        <div>
                            <label for="saveRouteNameInput" class="block text-sm font-medium text-slate-700 mb-3">××™×š ×œ×§×¨×•× ×œ××¡×œ×•×œ?</label>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <input type="text" id="saveRouteNameInput" placeholder="×œ×“×•×’××”: ××¡×œ×•×œ ×œ×§× ×™×•×ª"
                                       class="shadow-sm border border-slate-200 rounded-xl w-full py-2.5 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-200">
                                <button id="saveRouteBtn"
                                        class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2.5 px-5 rounded-xl whitespace-nowrap">
                                    âœ”ï¸ ×©××•×¨ ××¡×œ×•×œ
                                </button>
                            </div>
                            <div id="saveSuccess" class="mt-3 text-sm text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-xl px-3 py-2 hidden">
                                âœ… × ×©××¨ ×‘×”×¦×œ×—×”!
                            </div>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">××¡×œ×•×œ×™× ×©××•×¨×™×</p>
                            <div id="savedRoutesList" class="mt-3 grid gap-3 sm:grid-cols-2"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <section class="mt-6 bg-gradient-to-r from-indigo-50 to-emerald-50 border border-indigo-100 rounded-2xl p-4 sm:p-5">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-800">××•×›× ×™× ×œ×—×©×‘ ××¡×œ×•×œ?</h2>
                    <p class="text-sm text-slate-500">× ×—×©×‘ ×¡×“×¨ ××•×¤×˜×™××œ×™ ×‘×”×ª×× ×œ× ×§×•×“×•×ª ×©×‘×—×¨×ª.</p>
                </div>
                <button id="optimizeRouteBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-6 rounded-xl">
                    âš¡ ×—×©×‘ ××¡×œ×•×œ ××•×¤×˜×™××œ×™
                </button>
            </div>
            <div class="mt-4">
                <h3 class="text-sm font-semibold text-slate-700 mb-2">××¡×œ×•×œ ××•××œ×¥</h3>
                <ol id="optimizedRouteList" class="bg-white rounded-xl border border-slate-100 p-3 min-h-[80px]"></ol>
            </div>
            <button id="openInGoogleMapsBtn"
                    class="w-full sm:w-auto mt-4 bg-slate-900 hover:bg-slate-800 text-white font-semibold py-2.5 px-5 rounded-xl hidden">
                ğŸ§­ ×¤×ª×— ×‘××¤×•×ª Google
            </button>
        </section>

        <div class="text-xs text-slate-400 mt-6 text-center">
            ×—×™×¤×•×© ×›×ª×•×‘×•×ª ×‘×××¦×¢×•×ª <a href="https://nominatim.org/" target="_blank" class="underline">Nominatim</a> Â·
            × ×™×ª×•×‘ ×‘×××¦×¢×•×ª <a href="http://project-osrm.org/" target="_blank" class="underline">OSRM</a>.
        </div>
    </div>
    <script src="src/optimizer.js"></script>
    <script src="src/geocode.js"></script>

    <script>
        let intermediateLocations = [];
        let startLocation = null;
        let endLocation = null;
        let lastOptimizedRoute = [];
        let activeStep = 1;
        let draggedIntermediateIndex = null;

        const startAddressInput = document.getElementById('startAddressInput');
        const setStartLocationBtn = document.getElementById('setStartLocationBtn');
        const currentStartLocationDiv = document.getElementById('currentStartLocation');
        const clearStartLocationBtn = document.getElementById('clearStartLocationBtn');

        const endAddressInput = document.getElementById('endAddressInput');
        const setEndLocationBtn = document.getElementById('setEndLocationBtn');
        const currentEndLocationDiv = document.getElementById('currentEndLocation');
        const clearEndLocationBtn = document.getElementById('clearEndLocationBtn');

        const intermediateAddressInput = document.getElementById('intermediateAddressInput');
        const addIntermediateLocationBtn = document.getElementById('addIntermediateLocationBtn');
        const intermediateLocationsList = document.getElementById('intermediateLocationsList');

        const saveRouteNameInput = document.getElementById('saveRouteNameInput');
        const saveRouteBtn = document.getElementById('saveRouteBtn');
        const savedRoutesList = document.getElementById('savedRoutesList');
        const saveSuccess = document.getElementById('saveSuccess');

        const optimizeRouteBtn = document.getElementById('optimizeRouteBtn');
        const optimizedRouteList = document.getElementById('optimizedRouteList');
        const messageBox = document.getElementById('messageBox');
        const openInGoogleMapsBtn = document.getElementById('openInGoogleMapsBtn');
        const startSuggestions = document.getElementById('startSuggestions');
        const endSuggestions = document.getElementById('endSuggestions');
        const intermediateSuggestions = document.getElementById('intermediateSuggestions');

        const startStepStatus = document.getElementById('startStepStatus');
        const endStepStatus = document.getElementById('endStepStatus');
        const intermediateStepStatus = document.getElementById('intermediateStepStatus');
        const saveStepStatus = document.getElementById('saveStepStatus');

        const stepCards = Array.from(document.querySelectorAll('.step-card'));

        startAddressInput.addEventListener('input', () => updateSuggestions(startAddressInput, startSuggestions));
        endAddressInput.addEventListener('input', () => updateSuggestions(endAddressInput, endSuggestions));
        intermediateAddressInput.addEventListener('input', () => updateSuggestions(intermediateAddressInput, intermediateSuggestions));

        const TSP_MAX_INTERMEDIATE_POINTS = 8;
        const SAVED_ROUTES_KEY = 'savedRoutes';

        function showMessage(message, type = 'info') {
            const palette = {
                info: 'bg-slate-100 text-slate-700 border border-slate-200',
                success: 'bg-emerald-50 text-emerald-700 border border-emerald-100',
                error: 'bg-rose-50 text-rose-700 border border-rose-100'
            };
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âš ï¸' : 'â„¹ï¸';
            messageBox.textContent = `${icon} ${message}`;
            messageBox.className = `mt-4 p-3 rounded-xl ${palette[type] || palette.info}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 4500);
        }

        function setActiveStep(stepNumber) {
            activeStep = stepNumber;
            stepCards.forEach((card) => {
                const step = Number(card.dataset.step);
                const isActive = step === stepNumber;
                card.dataset.active = isActive ? 'true' : 'false';
                const body = card.querySelector('.step-body');
                if (body) {
                    body.classList.toggle('hidden', !isActive);
                }
            });
        }

        function updateStepProgress() {
            const startComplete = Boolean(startLocation);
            const endComplete = Boolean(endLocation);
            const intermediateComplete = intermediateLocations.length > 0;
            const savedComplete = loadSavedRoutes().length > 0;

            stepCards.forEach((card) => {
                const step = Number(card.dataset.step);
                if (step === 1) {
                    card.dataset.complete = startComplete ? 'true' : 'false';
                }
                if (step === 2) {
                    card.dataset.complete = endComplete ? 'true' : 'false';
                }
                if (step === 3) {
                    card.dataset.complete = intermediateComplete ? 'true' : 'false';
                }
                if (step === 4) {
                    card.dataset.complete = savedComplete ? 'true' : 'false';
                }
            });

            startStepStatus.textContent = formatLocationStatus(startLocation, 'â³ ×¢×“×™×™×Ÿ ×œ× × ×‘×—×¨×”');
            endStepStatus.textContent = formatLocationStatus(endLocation, 'â³ ×¢×“×™×™×Ÿ ×œ× × ×‘×—×¨×”');
            intermediateStepStatus.textContent = intermediateComplete ? `âœ”ï¸ ${intermediateLocations.length} ×¢×¦×™×¨×•×ª` : 'â• ×”×•×¡×¤×” ×—×•×¤×©×™×ª';
            saveStepStatus.textContent = savedComplete ? 'âœ”ï¸ ×™×© ××¡×œ×•×œ×™× ×©××•×¨×™×' : 'ğŸ’¾ ×¢×“×™×™×Ÿ ×œ× × ×©××¨';

            if (startComplete && activeStep === 1) {
                setActiveStep(2);
            }
            if (startComplete && endComplete && activeStep === 2) {
                setActiveStep(3);
            }
        }

        document.querySelectorAll('[data-step-toggle]').forEach((button) => {
            button.addEventListener('click', () => {
                const step = Number(button.closest('.step-card').dataset.step);
                setActiveStep(step);
            });
        });

        function addIntermediateLocation(locationData) {
            const isDuplicate = intermediateLocations.some(loc =>
                loc.address === locationData.address ||
                (Math.abs(loc.lat - locationData.lat) < 0.0001 && Math.abs(loc.lng - locationData.lng) < 0.0001)
            );
            const isStartOrEnd = (startLocation && startLocation.address === locationData.address) ||
                                 (endLocation && endLocation.address === locationData.address);

            if (isDuplicate || isStartOrEnd) {
                showMessage('×”××™×§×•× ×”×–×” ×›×‘×¨ ××•×¤×™×¢ ×‘×¨×©×™××” ×©×œ×š.', 'info');
                return;
            }

            intermediateLocations.push(locationData);
            updateIntermediateLocationsList();
            clearRouteDisplay();
        }

        function loadSavedRoutes() {
            try {
                const raw = localStorage.getItem(SAVED_ROUTES_KEY);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.warn('Failed to read saved routes:', error);
                return [];
            }
        }

        function persistSavedRoutes(routes) {
            try {
                localStorage.setItem(SAVED_ROUTES_KEY, JSON.stringify(routes));
            } catch (error) {
                console.warn('Failed to save routes:', error);
                showMessage('×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××¡×œ×•×œ×™× ×‘×“×¤×“×¤×Ÿ ×”×–×”.', 'error');
            }
        }

        function buildDefaultRouteName() {
            const now = new Date();
            const datePart = now.toLocaleDateString('he-IL');
            const timePart = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            return `××¡×œ×•×œ ${datePart} ${timePart}`;
        }

        function updateSavedRoutesList() {
            const routes = loadSavedRoutes();
            savedRoutesList.innerHTML = '';
            if (routes.length === 0) {
                savedRoutesList.innerHTML = '<div class="text-sm text-slate-400 bg-white border border-slate-100 rounded-xl p-3">×¢×“×™×™×Ÿ ××™×Ÿ ××¡×œ×•×œ×™× ×©××•×¨×™×.</div>';
                updateStepProgress();
                return;
            }

            routes.forEach((route) => {
                const listItem = document.createElement('div');
                const totalPoints = [route.startLocation, ...(route.intermediateLocations || []), route.endLocation].filter(Boolean).length;
                listItem.className = 'bg-white border border-slate-100 rounded-xl p-4 flex flex-col gap-3';
                listItem.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-slate-800">${route.name}</p>
                        <p class="text-xs text-slate-400">${totalPoints} × ×§×•×“×•×ª ×‘××¡×œ×•×œ</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${route.id}" class="load-saved-route-btn bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm px-3 py-2 rounded-lg">×˜×¢×Ÿ</button>
                        <button data-id="${route.id}" class="delete-saved-route-btn text-slate-400 hover:text-rose-500 text-sm px-3 py-2 rounded-lg">××—×§</button>
                    </div>
                `;
                savedRoutesList.appendChild(listItem);
            });

            updateStepProgress();
        }

        function saveCurrentRoute() {
            const hasAnyLocation = startLocation || endLocation || intermediateLocations.length > 0;
            if (!hasAnyLocation) {
                showMessage('×‘×—×¨ ×œ×¤×—×•×ª × ×§×•×“×ª ×”×ª×—×œ×” ××• ×™×¢×“ ×›×“×™ ×œ×©××•×¨.', 'info');
                return;
            }

            const name = saveRouteNameInput.value.trim() || buildDefaultRouteName();
            const routes = loadSavedRoutes();
            const newRoute = {
                id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                name,
                startLocation,
                endLocation,
                intermediateLocations: [...intermediateLocations]
            };

            routes.unshift(newRoute);
            persistSavedRoutes(routes);
            saveRouteNameInput.value = '';
            updateSavedRoutesList();
            saveSuccess.classList.remove('hidden');
            saveSuccess.classList.add('save-success');
            setTimeout(() => {
                saveSuccess.classList.add('hidden');
                saveSuccess.classList.remove('save-success');
            }, 2500);
            showMessage('×”××¡×œ×•×œ × ×©××¨. ××¤×©×¨ ×œ×˜×¢×•×Ÿ ××•×ª×• ×‘×›×œ ×¨×’×¢.', 'success');
        }

        function loadRouteById(routeId) {
            const routes = loadSavedRoutes();
            const route = routes.find((item) => item.id === routeId);
            if (!route) {
                showMessage('×œ× × ××¦× ××¡×œ×•×œ ×œ×©×—×–×•×¨.', 'error');
                return;
            }

            startLocation = route.startLocation;
            endLocation = route.endLocation;
            intermediateLocations = Array.isArray(route.intermediateLocations) ? [...route.intermediateLocations] : [];
            updateFixedLocationDisplays();
            updateIntermediateLocationsList();
            clearRouteDisplay();
            showMessage('×”××¡×œ×•×œ × ×˜×¢×Ÿ. ××¤×©×¨ ×œ×”××©×™×š ×œ×¢×¨×™×›×”.', 'success');
            setActiveStep(3);
        }

        function deleteRouteById(routeId) {
            const routes = loadSavedRoutes().filter((route) => route.id !== routeId);
            persistSavedRoutes(routes);
            updateSavedRoutesList();
            showMessage('×”××¡×œ×•×œ ×”×•×¡×¨ ××”×©××™×¨×”.', 'info');
        }

        function renderIntermediateChip(location, index) {
            const chip = document.createElement('div');
            chip.className = 'chip flex items-center gap-2 bg-white border border-slate-200 rounded-full px-3 py-1.5 text-sm text-slate-600 shadow-sm';
            chip.setAttribute('draggable', 'true');
            chip.dataset.index = index;
            chip.innerHTML = `
                <span class="text-slate-400 cursor-grab">â ¿</span>
                <span>${location.address}</span>
                <button data-index="${index}" class="remove-intermediate-btn text-slate-400 hover:text-rose-500 text-xs">âœ•</button>
            `;
            return chip;
        }

        function updateIntermediateLocationsList() {
            intermediateLocationsList.innerHTML = '';
            if (intermediateLocations.length === 0) {
                intermediateLocationsList.innerHTML = '<span class="text-sm text-slate-400">××™×Ÿ ×¢×¦×™×¨×•×ª ×‘×™× ×™×™× ×¢×“×™×™×Ÿ.</span>';
            } else {
                intermediateLocations.forEach((location, index) => {
                    const chip = renderIntermediateChip(location, index);
                    intermediateLocationsList.appendChild(chip);
                });
            }
            updateStepProgress();
        }

        function updateFixedLocationDisplays() {
            currentStartLocationDiv.innerHTML = startLocation
                ? `<span class="inline-flex items-center gap-2 text-sm text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-full px-3 py-1">âœ”ï¸ ${startLocation.address}</span>`
                : '<span class="inline-flex items-center gap-2 text-sm text-slate-400 bg-white border border-slate-200 rounded-full px-3 py-1">â³ ×‘×—×¨ × ×§×•×“×ª ×”×ª×—×œ×”</span>';

            currentEndLocationDiv.innerHTML = endLocation
                ? `<span class="inline-flex items-center gap-2 text-sm text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-full px-3 py-1">âœ”ï¸ ${endLocation.address}</span>`
                : '<span class="inline-flex items-center gap-2 text-sm text-slate-400 bg-white border border-slate-200 rounded-full px-3 py-1">â³ ×‘×—×¨ × ×§×•×“×ª ×¡×™×•×</span>';

            updateStepProgress();
        }

        function formatLocationStatus(location, emptyText) {
            if (!location) {
                return emptyText;
            }
            return `âœ”ï¸ ${location.address}`;
        }

        function buildGeocodeFailureMessage(error) {
            const baseMessage = error instanceof Error && error.message ? error.message : '×©×’×™××” ×‘×—×™×¤×•×© ×”×›×ª×•×‘×ª. × ×¡×” ×©×•×‘.';
            if (window.location.protocol === 'file:') {
                return `${baseMessage} ×× ×¤×ª×—×ª ××ª ×”×§×•×‘×¥ ××§×•××™×ª, ×”×¤×¢×œ ×©×¨×ª ××§×•××™ ××• ×”×©×ª××© ×‘×“××• ×”××§×•×•×Ÿ.`;
            }
            return baseMessage;
        }

        async function geocodeAddressWithFallback(address, lang) {
            const primary = await geocodeAddress(address, lang);
            if (primary) {
                return { ...primary, wasNumberStripped: false };
            }
            const stripped = stripHouseNumber(address);
            if (!stripped || stripped === address) {
                return null;
            }
            const fallback = await geocodeAddress(stripped, lang);
            if (!fallback) {
                return null;
            }
            return { ...fallback, wasNumberStripped: true, strippedQuery: stripped };
        }

        function decorateLocationResult(locationData) {
            if (!locationData) {
                return null;
            }
            if (locationData.wasNumberStripped) {
                return {
                    ...locationData,
                    address: `${locationData.address} (×œ×œ× ××¡×¤×¨)`
                };
            }
            return locationData;
        }

        setStartLocationBtn.addEventListener('click', async () => {
            const address = startAddressInput.value.trim();
            if (address) {
                showMessage('××—×¤×© × ×§×•×“×ª ×”×ª×—×œ×”...', 'info');
                try {
                    const fullAddress = getFullAddress(startAddressInput);
                    const locData = await geocodeAddressWithFallback(fullAddress, detectLanguage(fullAddress));
                    if (locData) {
                        startLocation = decorateLocationResult(locData);
                        updateFixedLocationDisplays();
                        startAddressInput.value = '';
                        showMessage(locData.wasNumberStripped ? '× ×§×•×“×ª ×”×ª×—×œ×” × ×‘×—×¨×” ×œ×œ× ××¡×¤×¨.' : '× ×§×•×“×ª ×”×ª×—×œ×” × ×‘×—×¨×”.', 'success');
                        clearRouteDisplay();
                    } else {
                        showMessage('×œ× × ××¦××” ×›×ª×•×‘×ª ×¢×‘×•×¨ × ×§×•×“×ª ×”×”×ª×—×œ×”.', 'error');
                    }
                } catch (error) {
                    showMessage(buildGeocodeFailureMessage(error), 'error');
                }
            } else {
                showMessage('×›×ª×•×‘ ×›×ª×•×‘×ª ×›×“×™ ×œ×‘×—×•×¨ × ×§×•×“×ª ×”×ª×—×œ×”.', 'info');
            }
        });

        clearStartLocationBtn.addEventListener('click', () => {
            startLocation = null;
            updateFixedLocationDisplays();
            showMessage('× ×§×•×“×ª ×”×”×ª×—×œ×” ×”×•×¡×¨×”.', 'info');
            clearRouteDisplay();
            setActiveStep(1);
        });

        setEndLocationBtn.addEventListener('click', async () => {
            const address = endAddressInput.value.trim();
            if (address) {
                showMessage('××—×¤×© × ×§×•×“×ª ×¡×™×•×...', 'info');
                try {
                    const fullAddress = getFullAddress(endAddressInput);
                    const locData = await geocodeAddressWithFallback(fullAddress, detectLanguage(fullAddress));
                    if (locData) {
                        endLocation = decorateLocationResult(locData);
                        updateFixedLocationDisplays();
                        endAddressInput.value = '';
                        showMessage(locData.wasNumberStripped ? '× ×§×•×“×ª ×¡×™×•× × ×‘×—×¨×” ×œ×œ× ××¡×¤×¨.' : '× ×§×•×“×ª ×¡×™×•× × ×‘×—×¨×”.', 'success');
                        clearRouteDisplay();
                    } else {
                        showMessage('×œ× × ××¦××” ×›×ª×•×‘×ª ×¢×‘×•×¨ × ×§×•×“×ª ×”×¡×™×•×.', 'error');
                    }
                } catch (error) {
                    showMessage(buildGeocodeFailureMessage(error), 'error');
                }
            } else {
                showMessage('×›×ª×•×‘ ×›×ª×•×‘×ª ×›×“×™ ×œ×‘×—×•×¨ × ×§×•×“×ª ×¡×™×•×.', 'info');
            }
        });

        clearEndLocationBtn.addEventListener('click', () => {
            endLocation = null;
            updateFixedLocationDisplays();
            showMessage('× ×§×•×“×ª ×”×¡×™×•× ×”×•×¡×¨×”.', 'info');
            clearRouteDisplay();
            setActiveStep(2);
        });

        addIntermediateLocationBtn.addEventListener('click', async () => {
            const address = intermediateAddressInput.value.trim();
            if (address) {
                showMessage('××—×¤×© ×¢×¦×™×¨×ª ×‘×™× ×™×™×...', 'info');
                try {
                    const fullAddress = getFullAddress(intermediateAddressInput);
                    const locData = await geocodeAddressWithFallback(fullAddress, detectLanguage(fullAddress));
                    if (locData) {
                        addIntermediateLocation(decorateLocationResult(locData));
                        intermediateAddressInput.value = '';
                        showMessage(locData.wasNumberStripped ? '×¢×¦×™×¨×ª ×‘×™× ×™×™× × ×•×¡×¤×” ×œ×œ× ××¡×¤×¨.' : '×¢×¦×™×¨×ª ×‘×™× ×™×™× × ×•×¡×¤×”.', 'success');
                    } else {
                        showMessage('×œ× × ××¦××” ×›×ª×•×‘×ª ×¢×‘×•×¨ ×”×—×™×¤×•×©.', 'error');
                    }
                } catch (error) {
                    showMessage(buildGeocodeFailureMessage(error), 'error');
                }
            } else {
                showMessage('×›×ª×•×‘ ×›×ª×•×‘×ª ×›×“×™ ×œ×”×•×¡×™×£ ×¢×¦×™×¨×”.', 'info');
            }
        });

        intermediateLocationsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-intermediate-btn')) {
                const indexToRemove = parseInt(event.target.dataset.index);
                intermediateLocations.splice(indexToRemove, 1);
                updateIntermediateLocationsList();
                clearRouteDisplay();
            }
        });

        intermediateLocationsList.addEventListener('dragstart', (event) => {
            const target = event.target.closest('.chip');
            if (!target) return;
            draggedIntermediateIndex = Number(target.dataset.index);
            target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        });

        intermediateLocationsList.addEventListener('dragend', (event) => {
            const target = event.target.closest('.chip');
            if (target) {
                target.classList.remove('dragging');
            }
            draggedIntermediateIndex = null;
        });

        intermediateLocationsList.addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        intermediateLocationsList.addEventListener('drop', (event) => {
            event.preventDefault();
            const targetChip = event.target.closest('.chip');
            if (!targetChip || draggedIntermediateIndex === null) return;
            const dropIndex = Number(targetChip.dataset.index);
            if (dropIndex === draggedIntermediateIndex) return;
            const [moved] = intermediateLocations.splice(draggedIntermediateIndex, 1);
            intermediateLocations.splice(dropIndex, 0, moved);
            updateIntermediateLocationsList();
            clearRouteDisplay();
            showMessage('×”×¡×“×¨ ×¢×•×“×›×Ÿ.', 'success');
        });

        saveRouteBtn.addEventListener('click', saveCurrentRoute);

        savedRoutesList.addEventListener('click', (event) => {
            if (event.target.classList.contains('load-saved-route-btn')) {
                const routeId = event.target.dataset.id;
                loadRouteById(routeId);
            }
            if (event.target.classList.contains('delete-saved-route-btn')) {
                const routeId = event.target.dataset.id;
                deleteRouteById(routeId);
            }
        });

        function clearRouteDisplay() {
            optimizedRouteList.innerHTML = '<li class="text-sm text-slate-400">×”××¡×œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ ×œ××—×¨ ×—×™×©×•×‘.</li>';
            openInGoogleMapsBtn.classList.add('hidden');
            lastOptimizedRoute = [];
        }

        async function getOSRMTable(coords) {
            const coordinatesString = coords.map(loc => `${loc.lng},${loc.lat}`).join(';');
            const url = `https://router.project-osrm.org/table/v1/driving/${coordinatesString}?sources=all&destinations=all`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`OSRM Table API error: ${response.statusText} (Status: ${response.status})`);
                }
                const data = await response.json();
                return data.durations;
            } catch (error) {
                console.error('Error fetching OSRM table:', error);
                showMessage('×©×’×™××” ×‘×—×™×©×•×‘ ×–×× ×™ × ×¡×™×¢×”. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'error');
                return null;
            }
        }

        function openInGoogleMaps() {
            if (lastOptimizedRoute.length < 2) {
                showMessage('××™×Ÿ ××¡×œ×•×œ ××—×•×©×‘ ×œ×¤×ª×™×—×” ×‘××¤×•×ª Google.', 'info');
                return;
            }

            let origin = '';
            let destination = '';
            let waypoints = [];

            if (lastOptimizedRoute.length === 2) {
                origin = `${lastOptimizedRoute[0].lat},${lastOptimizedRoute[0].lng}`;
                destination = `${lastOptimizedRoute[1].lat},${lastOptimizedRoute[1].lng}`;
            } else {
                origin = `${lastOptimizedRoute[0].lat},${lastOptimizedRoute[0].lng}`;
                destination = `${lastOptimizedRoute[lastOptimizedRoute.length - 1].lat},${lastOptimizedRoute[lastOptimizedRoute.length - 1].lng}`;
                waypoints = lastOptimizedRoute.slice(1, -1).map(loc => `${loc.lat},${loc.lng}`);
            }

            let googleMapsUrl = `https://www.google.com/maps/dir/?api=1`;
            googleMapsUrl += `&origin=${encodeURIComponent(origin)}`;
            googleMapsUrl += `&destination=${encodeURIComponent(destination)}`;
            if (waypoints.length > 0) {
                googleMapsUrl += `&waypoints=${encodeURIComponent(waypoints.join('|'))}`;
            }
            googleMapsUrl += `&travelmode=driving`;

            window.open(googleMapsUrl, '_blank');
        }

        optimizeRouteBtn.addEventListener('click', async () => {
            let allPointsForOSRM = [];
            if (startLocation) allPointsForOSRM.push(startLocation);
            allPointsForOSRM = allPointsForOSRM.concat(intermediateLocations);
            if (endLocation) allPointsForOSRM.push(endLocation);

            if (allPointsForOSRM.length < 2) {
                showMessage('×‘×—×¨ ×œ×¤×—×•×ª ×©×ª×™ × ×§×•×“×•×ª ×›×“×™ ×œ×—×©×‘ ××¡×œ×•×œ.', 'info');
                optimizedRouteList.innerHTML = '<li class="text-sm text-slate-400">×”×•×¡×£ ×œ×¤×—×•×ª ×©×ª×™ × ×§×•×“×•×ª.</li>';
                clearRouteDisplay();
                return;
            }

            if (intermediateLocations.length <= TSP_MAX_INTERMEDIATE_POINTS) {
                showMessage('××—×©×‘ ××¡×œ×•×œ ××“×•×™×§ ×œ× ×§×•×“×•×ª ×©×‘×—×¨×ª...', 'info');
            } else {
                showMessage('××—×©×‘ ××¡×œ×•×œ ××”×™×¨ ×œ× ×§×•×“×•×ª ×©×‘×—×¨×ª...', 'info');
            }
            optimizedRouteList.innerHTML = '<li class="text-sm text-slate-400">×‘×˜×¢×™× ×”...</li>';
            openInGoogleMapsBtn.classList.add('hidden');

            try {
                const durationsMatrix = await getOSRMTable(allPointsForOSRM);

                if (!durationsMatrix) {
                    optimizedRouteList.innerHTML = '<li class="text-sm text-slate-400">×©×’×™××” ×‘×—×™×©×•×‘ ×”××¡×œ×•×œ.</li>';
                    return;
                }

                let optimizedRoute;
                if (intermediateLocations.length <= TSP_MAX_INTERMEDIATE_POINTS) {
                    optimizedRoute = solveTSP(intermediateLocations, durationsMatrix, startLocation, endLocation, allPointsForOSRM);
                } else {
                    optimizedRoute = optimizeRouteNearestNeighbor(intermediateLocations, durationsMatrix, startLocation, endLocation, allPointsForOSRM);
                }

                optimizedRouteList.innerHTML = '';
                optimizedRoute.forEach((location, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'py-1 px-2 border-b border-slate-100 last:border-b-0 text-sm text-slate-700';
                    listItem.textContent = `${index + 1}. ${location.address}`;
                    optimizedRouteList.appendChild(listItem);
                });

                lastOptimizedRoute = optimizedRoute;
                openInGoogleMapsBtn.classList.remove('hidden');

                showMessage('×”××¡×œ×•×œ ××•×›×Ÿ! ××¤×©×¨ ×œ×¤×ª×•×— ×‘××¤×•×ª Google.', 'success');

            } catch (error) {
                console.error('Optimization process failed:', error);
                showMessage('×©×’×™××” ×‘××•×¤×˜×™××™×–×¦×™×” ×©×œ ×”××¡×œ×•×œ. ×‘×“×•×§ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜ ×•×›×ª×•×‘×•×ª.', 'error');
                optimizedRouteList.innerHTML = '<li class="text-sm text-slate-400">×©×’×™××” ×‘×—×™×©×•×‘ ×”××¡×œ×•×œ.</li>';
            }
        });

        openInGoogleMapsBtn.addEventListener('click', openInGoogleMaps);

        updateIntermediateLocationsList();
        updateFixedLocationDisplays();
        updateSavedRoutesList();
        clearRouteDisplay();
        setActiveStep(1);
    </script>
</body>
</html>
